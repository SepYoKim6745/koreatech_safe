# VLM Chatbot 시스템 아키텍처

## 1. 시스템 구성도 (System Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              전체 시스템 구성                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│    ┌─────────────┐                                                              │
│    │   사용자     │                                                              │
│    │  (Browser)  │                                                              │
│    └──────┬──────┘                                                              │
│           │ HTTP/HTTPS                                                          │
│           ▼                                                                     │
│    ┌─────────────────────────────────────────────────────────┐                  │
│    │              클라우드 서버 (Rocky Linux)                  │                  │
│    │                                                         │                  │
│    │   ┌─────────────────────────────────────────────────┐   │                  │
│    │   │                 Nginx (:80/:443)                │   │                  │
│    │   │         (리버스 프록시 + 정적 파일 서빙)          │   │                  │
│    │   └────────────────────┬────────────────────────────┘   │                  │
│    │                        │                                │                  │
│    │          ┌─────────────┴─────────────┐                  │                  │
│    │          │                           │                  │                  │
│    │          ▼                           ▼                  │                  │
│    │   ┌─────────────┐           ┌─────────────┐             │                  │
│    │   │ Frontend    │           │ Backend     │             │                  │
│    │   │ (React)     │           │ (FastAPI)   │             │                  │
│    │   │ 정적 파일    │           │ :8080       │             │                  │
│    │   └─────────────┘           └──────┬──────┘             │                  │
│    │                                    │                    │                  │
│    └────────────────────────────────────┼────────────────────┘                  │
│                                         │ HTTP API                              │
│                                         │ (OpenAI 호환)                          │
│                                         ▼                                       │
│    ┌─────────────────────────────────────────────────────────┐                  │
│    │                   GPU 서버                               │                  │
│    │                                                         │                  │
│    │   ┌─────────────────────────────────────────────────┐   │                  │
│    │   │              vLLM Server (:8000)                │   │                  │
│    │   │                                                 │   │                  │
│    │   │   ┌─────────────────────────────────────────┐   │   │                  │
│    │   │   │           VLM Model                     │   │   │                  │
│    │   │   │      (GPU Memory에 로드됨)               │   │   │                  │
│    │   │   └─────────────────────────────────────────┘   │   │                  │
│    │   │                                                 │   │                  │
│    │   └─────────────────────────────────────────────────┘   │                  │
│    │                                                         │                  │
│    └─────────────────────────────────────────────────────────┘                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 소프트웨어 구성도 (Software Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           소프트웨어 스택                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         Frontend (React + Vite)                           │  │
│  ├───────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                           │  │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐   │  │
│  │   │   App.jsx       │  │ ChatInterface   │  │    ImageUpload.jsx      │   │  │
│  │   │   (Router)      │  │    .jsx         │  │    (이미지 미리보기)     │   │  │
│  │   └─────────────────┘  └────────┬────────┘  └─────────────────────────┘   │  │
│  │                                 │                                         │  │
│  │                                 ▼                                         │  │
│  │                        ┌─────────────────┐                                │  │
│  │                        │  api/client.js  │                                │  │
│  │                        │  (Axios HTTP)   │                                │  │
│  │                        └────────┬────────┘                                │  │
│  │                                 │                                         │  │
│  └─────────────────────────────────┼─────────────────────────────────────────┘  │
│                                    │ HTTP POST /api/chat/message               │
│                                    ▼                                           │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        Backend (FastAPI + Python)                         │  │
│  ├───────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                           │  │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐   │  │
│  │   │   main.py       │  │  api/chat.py    │  │     config.py           │   │  │
│  │   │   (FastAPI App) │  │  (API Router)   │  │     (환경설정)           │   │  │
│  │   └─────────────────┘  └────────┬────────┘  └─────────────────────────┘   │  │
│  │                                 │                                         │  │
│  │                                 ▼                                         │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐     │  │
│  │   │                 services/vlm_service.py                         │     │  │
│  │   ├─────────────────────────────────────────────────────────────────┤     │  │
│  │   │  - create_message_content()  : 메시지 컨텐츠 생성 (다중 이미지)  │     │  │
│  │   │  - build_messages()          : 채팅 히스토리 구성               │     │  │
│  │   │  - chat()                    : vLLM API 호출                   │     │  │
│  │   └─────────────────────────────────────────────────────────────────┘     │  │
│  │                                 │                                         │  │
│  │                                 │ OpenAI API 호환 요청                     │  │
│  └─────────────────────────────────┼─────────────────────────────────────────┘  │
│                                    │                                           │
│                                    ▼                                           │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                          vLLM Server                                      │  │
│  ├───────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                           │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐     │  │
│  │   │                    OpenAI-Compatible API                        │     │  │
│  │   │                    POST /v1/chat/completions                    │     │  │
│  │   └─────────────────────────────────────────────────────────────────┘     │  │
│  │                                 │                                         │  │
│  │                                 ▼                                         │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐     │  │
│  │   │                      VLM Model                                  │     │  │
│  │   │              (Vision-Language Model)                            │     │  │
│  │   │                                                                 │     │  │
│  │   │    Input: [텍스트] + [이미지 1~N개 (base64)]                     │     │  │
│  │   │    Output: [분석 결과 텍스트]                                    │     │  │
│  │   └─────────────────────────────────────────────────────────────────┘     │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 네트워크 구성도 (Network Architecture)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            네트워크 구성                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                              인터넷 (Internet)                                   │
│                                    │                                            │
│                                    │ HTTPS (:443)                               │
│                                    ▼                                            │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                           │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐     │  │
│  │   │                    방화벽 (Firewall)                            │     │  │
│  │   │              허용 포트: 22(SSH), 80, 443                        │     │  │
│  │   └─────────────────────────────────────────────────────────────────┘     │  │
│  │                                 │                                         │  │
│  │                                 ▼                                         │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐     │  │
│  │   │              클라우드 서버 (Rocky Linux)                         │     │  │
│  │   │              Public IP: xxx.xxx.xxx.xxx                         │     │  │
│  │   │              Domain: your-domain.com                            │     │  │
│  │   ├─────────────────────────────────────────────────────────────────┤     │  │
│  │   │                                                                 │     │  │
│  │   │    ┌─────────────────────────────────────────────────────┐     │     │  │
│  │   │    │              Nginx (:80/:443)                       │     │     │  │
│  │   │    │                                                     │     │     │  │
│  │   │    │   /           →  정적 파일 (/var/www/frontend)      │     │     │  │
│  │   │    │   /api/*      →  proxy_pass http://127.0.0.1:8080  │     │     │  │
│  │   │    │                                                     │     │     │  │
│  │   │    └──────────────────────────┬──────────────────────────┘     │     │  │
│  │   │                               │                                │     │  │
│  │   │                               ▼                                │     │  │
│  │   │    ┌─────────────────────────────────────────────────────┐     │     │  │
│  │   │    │          Backend (127.0.0.1:8080)                   │     │     │  │
│  │   │    │          (로컬에서만 접근 가능)                       │     │     │  │
│  │   │    └──────────────────────────┬──────────────────────────┘     │     │  │
│  │   │                               │                                │     │  │
│  │   └───────────────────────────────┼────────────────────────────────┘     │  │
│  │                                   │                                       │  │
│  │              내부 네트워크 / VPN   │  HTTP (:8000)                         │  │
│  │                                   │                                       │  │
│  │   ┌───────────────────────────────▼────────────────────────────────┐     │  │
│  │   │                    GPU 서버                                    │     │  │
│  │   │              Internal IP: 192.168.x.x                         │     │  │
│  │   ├───────────────────────────────────────────────────────────────┤     │  │
│  │   │                                                               │     │  │
│  │   │    ┌─────────────────────────────────────────────────────┐    │     │  │
│  │   │    │              방화벽 (Firewall)                      │    │     │  │
│  │   │    │     허용: 클라우드 서버 IP에서 :8000 접근만 허용     │    │     │  │
│  │   │    └─────────────────────────────────────────────────────┘    │     │  │
│  │   │                               │                               │     │  │
│  │   │                               ▼                               │     │  │
│  │   │    ┌─────────────────────────────────────────────────────┐    │     │  │
│  │   │    │              vLLM Server (:8000)                    │    │     │  │
│  │   │    │              (외부 직접 접근 차단)                   │    │     │  │
│  │   │    └─────────────────────────────────────────────────────┘    │     │  │
│  │   │                                                               │     │  │
│  │   └───────────────────────────────────────────────────────────────┘     │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 데이터 흐름도 (Data Flow)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              요청/응답 흐름                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   [1] 사용자 요청                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  사용자가 이미지 + 질문 입력                                              │   │
│   │  예: "이 이미지에서 위험요소를 찾아줘" + 이미지 2장                        │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│                                    ▼                                            │
│   [2] 프론트엔드 처리                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  - 이미지를 Base64로 인코딩                                              │   │
│   │  - JSON 요청 생성:                                                       │   │
│   │    {                                                                     │   │
│   │      "message": "이 이미지에서 위험요소를 찾아줘",                         │   │
│   │      "images": ["data:image/jpeg;base64,...", "data:image/..."],         │   │
│   │      "history": [...]                                                    │   │
│   │    }                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│                                    ▼                                            │
│   [3] 백엔드 처리                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  - 요청 검증                                                             │   │
│   │  - OpenAI API 형식으로 변환:                                             │   │
│   │    messages: [                                                           │   │
│   │      {                                                                   │   │
│   │        "role": "user",                                                   │   │
│   │        "content": [                                                      │   │
│   │          {"type": "text", "text": "이 이미지에서..."},                    │   │
│   │          {"type": "image_url", "image_url": {"url": "data:..."}},        │   │
│   │          {"type": "image_url", "image_url": {"url": "data:..."}}         │   │
│   │        ]                                                                 │   │
│   │      }                                                                   │   │
│   │    ]                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│                                    ▼                                            │
│   [4] vLLM 처리 (GPU)                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  - 이미지 디코딩 및 전처리                                               │   │
│   │  - Vision Encoder로 이미지 특징 추출                                     │   │
│   │  - Language Model로 텍스트 생성                                          │   │
│   │  - 응답: "이 이미지에서 발견된 위험요소는..."                              │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│                                    ▼                                            │
│   [5] 응답 반환                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  vLLM → 백엔드 → 프론트엔드 → 사용자 화면에 표시                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 포트 및 프로토콜 정리

| 구분 | 포트 | 프로토콜 | 설명 |
|------|------|----------|------|
| Nginx (HTTP) | 80 | HTTP | HTTPS 리다이렉트 |
| Nginx (HTTPS) | 443 | HTTPS | 메인 서비스 |
| Backend | 8080 | HTTP | FastAPI (로컬만) |
| vLLM | 8000 | HTTP | 모델 서빙 (내부망) |
| SSH | 22 | SSH | 서버 관리 |

---

## 6. 기술 스택 요약

```
┌─────────────────────────────────────────────────────────────────┐
│                        기술 스택                                 │
├─────────────────┬───────────────────────────────────────────────┤
│ Frontend        │ React 18, Vite, Axios, React-Markdown         │
├─────────────────┼───────────────────────────────────────────────┤
│ Backend         │ Python 3.11, FastAPI, Uvicorn, OpenAI SDK     │
├─────────────────┼───────────────────────────────────────────────┤
│ Model Serving   │ vLLM (OpenAI API 호환)                        │
├─────────────────┼───────────────────────────────────────────────┤
│ Web Server      │ Nginx                                         │
├─────────────────┼───────────────────────────────────────────────┤
│ OS              │ Rocky Linux (클라우드), Ubuntu (GPU 서버)      │
└─────────────────┴───────────────────────────────────────────────┘
```
